import { env } from '@/env';
import type { Root } from '@/routes';
import { prisma, type User } from '@repo/prisma';
import { PublicKeyCredentialSchema } from '@repo/validation';
import { hc } from 'hono/client';
import { randomBytes } from 'node:crypto';
import { describe, test, expect, beforeAll } from 'vitest';

const testClient = hc<Root>(`http://localhost:${env.PORT}`);

describe('Credentials POST handler', () => {
  let user: User;

  beforeAll(async () => {
    user = await prisma.user.upsert({
      where: {
        email: 'john.doe@example.com',
      },
      update: {},
      create: {
        email: 'john.doe@example.com',
        name: 'John Doe',
      },
    });
  });

  test('f', async () => {
    const response = await testClient.credentials.$post({
      json: {
        challenge: randomBytes(16).toString('base64url'),
        rp: {
          id: 'example.com',
          name: 'example.com',
        },
        pubKeyCredParams: [{ alg: -7, type: 'public-key' }],
      },
    });

    expect(response.ok).toBe(true);

    const json = await response.json();

    const decoded = PublicKeyCredentialSchema.decode(json);

    expect(decoded).toMatchInlineSnapshot(`
      {
        "clientExtensionResults": {},
        "id": "maANT_H4S4STSwovR7ie-Q",
        "rawId": {
          "data": [
            153,
            160,
            13,
            79,
            241,
            248,
            75,
            132,
            147,
            75,
            10,
            47,
            71,
            184,
            158,
            249,
          ],
          "type": "Buffer",
        },
        "response": {
          "attestationObject": {
            "data": [
              163,
              99,
              102,
              109,
              116,
              100,
              110,
              111,
              110,
              101,
              103,
              97,
              116,
              116,
              83,
              116,
              109,
              116,
              160,
              104,
              97,
              117,
              116,
              104,
              68,
              97,
              116,
              97,
              88,
              148,
              163,
              121,
              166,
              246,
              238,
              175,
              185,
              165,
              94,
              55,
              140,
              17,
              128,
              52,
              226,
              117,
              30,
              104,
              47,
              171,
              159,
              45,
              48,
              171,
              19,
              210,
              18,
              85,
              134,
              206,
              25,
              71,
              69,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              0,
              16,
              153,
              160,
              13,
              79,
              241,
              248,
              75,
              132,
              147,
              75,
              10,
              47,
              71,
              184,
              158,
              249,
              165,
              3,
              38,
              1,
              2,
              32,
              1,
              33,
              88,
              32,
              22,
              136,
              254,
              115,
              231,
              122,
              65,
              51,
              90,
              68,
              69,
              172,
              237,
              187,
              162,
              15,
              132,
              131,
              81,
              225,
              159,
              176,
              85,
              232,
              69,
              87,
              22,
              40,
              169,
              194,
              203,
              133,
              34,
              88,
              32,
              109,
              58,
              106,
              65,
              144,
              187,
              133,
              136,
              106,
              241,
              9,
              163,
              27,
              248,
              240,
              44,
              85,
              140,
              9,
              86,
              225,
              235,
              206,
              199,
              118,
              253,
              41,
              205,
              103,
              149,
              210,
              129,
            ],
            "type": "Buffer",
          },
          "clientDataJSON": {
            "data": [
              123,
              34,
              116,
              121,
              112,
              101,
              34,
              58,
              34,
              119,
              101,
              98,
              97,
              117,
              116,
              104,
              110,
              46,
              99,
              114,
              101,
              97,
              116,
              101,
              34,
              44,
              34,
              99,
              104,
              97,
              108,
              108,
              101,
              110,
              103,
              101,
              34,
              58,
              34,
              52,
              120,
              95,
              74,
              78,
              105,
              104,
              119,
              78,
              57,
              117,
              87,
              78,
              111,
              105,
              70,
              75,
              54,
              108,
              65,
              66,
              103,
              34,
              44,
              34,
              111,
              114,
              105,
              103,
              105,
              110,
              34,
              58,
              34,
              101,
              120,
              97,
              109,
              112,
              108,
              101,
              46,
              99,
              111,
              109,
              34,
              44,
              34,
              99,
              114,
              111,
              115,
              115,
              79,
              114,
              105,
              103,
              105,
              110,
              34,
              58,
              102,
              97,
              108,
              115,
              101,
              125,
            ],
            "type": "Buffer",
          },
        },
        "type": "public-key",
      }
    `);
  });
});
